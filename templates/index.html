<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Circle of Fifths</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body {
  margin:0;
  font-family:system-ui,sans-serif;
  background:#0d1117;
  color:white;
  text-align:center;
}
h1 { margin-top:20px; }

svg { display:block; margin:auto; }

/* Arc slices */
.slice {
  fill:#161b22;
  stroke:white;
  stroke-width:1.5;
  cursor:pointer;
  transition: all 0.2s ease;
}

.slice:hover {
  filter: drop-shadow(0 0 10px white);
}

.slice.active {
  fill:#2c2f33;
  filter: drop-shadow(0 0 15px #9fd3ff);
}

.slice.root {
  fill:#00ffff;
  filter: drop-shadow(0 0 15px #00ffff);
}

/* Labels inside arcs */
.label {
  fill:white;
  font-weight:600;
  text-anchor:middle;
  dominant-baseline:middle;
  pointer-events:none;
  font-size:14px;
}

/* Center scale text */
#center-text {
  fill:#9fd3ff;
  font-size:44px;
  font-weight:bold;
  text-anchor:middle;
  dominant-baseline:middle;
}

/* Piano roll */
#piano {
  margin:50px auto;
  height:160px;
  position:relative;
  width:960px; /* wider to accommodate more octaves */
}

.white-key {
  position:absolute;
  width:60px;
  height:160px;
  background:#f5f5f5;
  border:1px solid #ccc;
}

.white-key.active { background:#9fd3ff; }
.white-key.root { background:#00ffff; }

.black-key {
  position:absolute;
  width:40px;
  height:100px;
  background:#111;
  z-index:2;
}

.black-key.active { background:#5fb3ff; }
.black-key.root { background:#00ffff; }
</style>
</head>
<body>

<h1>Circle of Fifths</h1>
<div id="chart"></div>
<div id="piano"></div>

<script>
/* =====================
  Data
===================== */
const majors = [
  "Bb","F","C","G","D","A","E","B","F#/Gb","C#/Db","Ab","Eb"
];

const minors = [
  "Gm","Dm","Am","Em","Bm","F#m/Gbm","C#m/Dbm","G#m","D#m/Ebm","A#m/Bbm","Fm","Cm"
];

const scales = {
    "C": ["C","D","E","F","G","A","B"],
    "G": ["G","A","B","C","D","E","F#"],
    "D": ["D","E","F#","G","A","B","C#"],
    "A": ["A","B","C#","D","E","F#","G#"],
    "E": ["E","F#","G#","A","B","C#","D#"],
    "B": ["B","C#","D#","E","F#","G#","A#"],
    "F#/Gb": ["F#","G#","A#","B","C#","D#","F"], 
    "C#/Db": ["Db","Eb","F","Gb","Ab","Bb","C"],
    "Ab": ["Ab","Bb","C","Db","Eb","F","G"],
    "Eb": ["Eb","F","G","Ab","Bb","C","D"],
    "Bb": ["Bb","C","D","Eb","F","G","A"],
    "F": ["F","G","A","Bb","C","D","E"],

    "Am": ["A","B","C","D","E","F","G"],
    "Em": ["E","F#","G","A","B","C","D"],
    "Bm": ["B","C#","D","E","F#","G","A"],
    "F#m/Gbm": ["F#","G#","A","B","C#","D","E"],
    "C#m/Dbm": ["C#","D#","E","F#","G#","A","B"],
    "G#m": ["G#","A#","B","C#","D#","E","F#"],
    "D#m/Ebm": ["D#","F","F#","G#","A#","B","C#"], 
    "A#m/Bbm": ["A#","C","C#","D#","F","F#","G#"], 
    "Fm": ["F","G","Ab","Bb","C","Db","Eb"],
    "Cm": ["C","D","Eb","F","G","Ab","Bb"],
    "Gm": ["G","A","Bb","C","D","Eb","F"],
    "Dm": ["D","E","F","G","A","Bb","C"]
};


/* =====================
  SVG Setup
===================== */
const width = 800;
const height = 800;
const radiusOuter = 350;
const radiusInner = 200;
const svg = d3.select("#chart")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .append("g")
  .attr("transform", `translate(${width/2},${height/2})`);

// Center text for scale
const centerText = svg.append("text")
  .attr("id","center-text")
  .attr("x",0)
  .attr("y",0)
  .text("");

/* =====================
  Draw Pie
===================== */
let activeSlice = null; 

function drawRing(keys, innerR, outerR) {
  const n = keys.length;
  const sliceAngle = 2*Math.PI / n;

  const pie = d3.pie()
    .value(1)
    .startAngle(-Math.PI/2 + sliceAngle/2) 
    .endAngle(3*Math.PI/2 + sliceAngle/2)
    .sort(null);

  const data_ready = pie(keys);

  const arc = d3.arc()
    .innerRadius(innerR)
    .outerRadius(outerR);

  svg.selectAll(null)
    .data(data_ready)
    .enter()
    .append("path")
    .attr("d", arc)
    .attr("class", "slice")
    .on("mouseover", function(e,d){
      if(this!==activeSlice) d3.select(this).attr("fill","#2c2f33");
    })
    .on("mouseout", function(e,d){
      if(this!==activeSlice) d3.select(this).attr("fill","#161b22");
    })
    .on("click", function(e,d){
      // Remove previous highlight
      if(activeSlice) d3.select(activeSlice).attr("fill","#161b22").classed("active",false).classed("root",false);
      activeSlice = this;

      // Mark root slice differently
      d3.select(this).attr("fill","#00ffff").classed("active",true).classed("root",true);

      const scale = scales[d.data];
      drawPiano(scale, scale[0]); // root is first note
      centerText.text(d.data);
    });

  /* Labels */
  svg.selectAll(null)
    .data(data_ready)
    .enter()
    .append("text")
    .attr("class","label")
    .attr("transform", d => {
      const [x,y] = arc.centroid(d);
      return `translate(${x},${y})`;
    })
    .text(d=>d.data);
}

drawRing(majors, radiusInner + 65, radiusOuter); 
drawRing(minors, radiusInner, radiusInner + 65); 

/* =====================
  Piano Roll
===================== */
const piano = document.getElementById("piano");
const whiteOrder = ["C","D","E","F","G","A","B"];
const blackMap = { "C":"C#","D":"D#","F":"F#","G":"G#","A":"A#" };

let whiteKeys = [];
let blackKeys = [];

const octaves = 4; // extend to 4 octaves
const keyWidth = 60; 
const blackWidth = 40;
const pianoWidth = whiteOrder.length*keyWidth*octaves;
piano.style.width = pianoWidth + "px";
piano.style.margin = "0 auto";

// Build white and black keys
for(let o=1;o<=octaves;o++){
  whiteOrder.forEach((note,i)=>{
    const key = document.createElement("div");
    key.className="white-key";
    key.dataset.note=note;
    key.style.left=`${((o-1)*7 + i)*keyWidth}px`;
    piano.appendChild(key);
    whiteKeys.push(key);

    if(blackMap[note]){
      const black = document.createElement("div");
      black.className="black-key";
      black.dataset.note=blackMap[note];
      black.style.left=`${((o-1)*7 + i)*keyWidth + 40}px`;
      piano.appendChild(black);
      blackKeys.push(black);
    }
  });
}

/* Highlight scale notes, root note separately */
function normalize(note){
  const flatMap = {
    "Db":"C#",
    "Eb":"D#",
    "Gb":"F#",
    "Ab":"G#",
    "Bb":"A#"
  };
  if(note.includes("/")) note = note.split("/")[0];
  note = note.replace("m","");
  return flatMap[note] || note;
}

function drawPiano(scale, root){
  const notes = scale.map(normalize);
  const rootNote = normalize(root);

  [...whiteKeys,...blackKeys].forEach(k=>{
    k.classList.remove("active","root");
    if(k.dataset.note===rootNote) k.classList.add("root");
    else if(notes.includes(k.dataset.note)) k.classList.add("active");
  });
}
</script>
</body>
</html>
